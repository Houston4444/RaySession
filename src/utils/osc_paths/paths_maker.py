#!/usr/bin/env python3

from pathlib import Path
from collections import defaultdict
import sys

header = '''
# This file has been generated by src/utils/osc_paths/path_makers.py.
# Do not edit it, edit 'all_paths' file and run 'path_makers.py'.'''

class FilePrepare:
    def __init__(self):
        self.imports = set[str]()
        self.defines = dict[str, str]()
    
    @property
    def contents(self) -> str:
        imports = '\n'.join([
            f'from . import {m}' for m in self.imports])
        defines = '\n'.join([
            f"{k} = '{v}'" for k, v in self.defines.items()])
        return '\n\n'.join([header, imports, defines])

paths_file = Path(__file__).parent / 'all_paths'

with open(paths_file, 'r') as f:
    contents = f.read()

all_paths = contents.splitlines()

code_root = paths_file.parent
while code_root.name != 'RaySession':
    code_root = code_root.parent
    if code_root.name == '/':
        print('this file is not in a RaySession folder, exit.')
        sys.exit(1)

root = code_root / 'src' / 'shared' / 'osc_paths'
root.mkdir(exist_ok=True)

file_prepares = defaultdict[Path, FilePrepare](FilePrepare)

for osc_str in all_paths:
    osc_str = osc_str.strip()
    if not osc_str.startswith('/'):
        continue

    p = root / osc_str[1:]
    pdir = p.parent
    
    file_prepares[pdir].defines[p.name.upper()] = osc_str
    
    while root in pdir.parents or root == pdir.parent:
        file_prepares[pdir.parent].imports.add(pdir.name)
        pdir = pdir.parent

for path, file_prepare in file_prepares.items():
    path.mkdir(exist_ok=True, parents=True)
    
    init_py = path / '__init__.py'
    with open (init_py, 'w') as f:
        f.write(file_prepare.contents)